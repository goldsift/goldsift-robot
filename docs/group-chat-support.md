# 群聊支持和并发控制功能说明

本文档介绍了加密货币交易分析机器人的群聊支持和并发控制功能。

## 功能概述

### 群聊支持
- 机器人现在可以加入 Telegram 群聊
- 在群聊中，只有以下情况机器人才会响应：
  - 用户直接@机器人（例如：`@your_bot_name 分析BTC/USDT`）
  - 回复机器人的消息
- 私聊中机器人会响应所有消息（保持原有行为）

### 新成员欢迎功能
- 当新用户加入群聊时，机器人会自动发送欢迎消息
- 欢迎消息包含详细的使用说明和示例
- 支持单个或多个用户同时加入的情况
- 可通过环境变量配置开启/关闭此功能

### 并发控制
- **单群限制**：每个群同时只能进行一个分析任务
- **全局限制**：所有群加起来最多同时进行N个分析任务（默认10个，可配置）
- **互不影响**：私聊和群聊分析互不影响，不同群之间也互不影响

## 配置说明

### 环境变量配置

在 `.env` 文件中添加以下配置：

```env
# 并发控制配置
# 全局最大并发分析数量（1-100之间，默认10）
MAX_CONCURRENT_ANALYSIS=10

# 新成员欢迎消息配置
ENABLE_NEW_MEMBER_WELCOME=true
```

### 配置参数说明

- `MAX_CONCURRENT_ANALYSIS`: 全局最大并发分析数量
  - 范围：1-100
  - 默认值：10
  - 说明：控制整个机器人同时能处理的最大分析任务数

- `ENABLE_NEW_MEMBER_WELCOME`: 新成员欢迎消息开关
  - 值：true/false
  - 默认值：true
  - 说明：控制是否为新加入群聊的用户发送欢迎消息

## 使用方法

### 在群聊中使用

1. **将机器人添加到群聊**
   - 邀请机器人进入群聊
   - 机器人会发送欢迎消息，介绍使用方法

2. **@机器人进行分析**
   ```
   @your_bot_name 分析 BTC/USDT
   @your_bot_name ETHUSDT 现在走势如何？
   @your_bot_name 帮我看看 SOL 的技术指标
   ```

3. **回复机器人消息**
   - 可以回复机器人的任何消息进行进一步对话
   - 机器人会识别这是对它的回复并进行响应

### 在私聊中使用

私聊使用方法保持不变：
```
分析 BTC/USDT
ETHUSDT 现在走势如何？
帮我看看 SOL 的技术指标
```

## 并发控制行为

### 正常情况
- 用户发送分析请求
- 系统检查并发限制
- 如果未达到限制，开始分析
- 分析完成后释放并发槽位

### 达到限制时
- 系统会返回友好的错误提示
- 提示用户稍后再试
- 显示当前的并发限制信息

### 错误提示示例
```
🚦 当前分析请求过多，请稍后再试。（单群限制：一次一个分析，全局限制：最多10个并发分析）
```

## 日志记录

系统会记录以下关键信息：
- 群聊消息的处理状态
- 并发控制的决策过程
- 分析任务的开始和完成
- 机器人加入新群聊的事件

### 日志示例
```
INFO: 收到用户消息 {"chatId": -1001234567890, "chatType": "supergroup", "isGroupMessage": true}
INFO: 开始分析 {"chatId": -1001234567890, "globalCount": 3, "maxConcurrent": 10}
INFO: 完成分析 {"chatId": -1001234567890, "globalCount": 2, "maxConcurrent": 10}
```

## 技术实现

### 核心组件

1. **ConcurrencyManager** (`src/concurrency.ts`)
   - 管理全局并发状态
   - 跟踪每个群的分析状态
   - 提供并发控制接口

2. **群聊消息识别** (`src/bot.ts`)
   - `isMessageForBot()`: 判断消息是否针对机器人
   - `cleanMessageText()`: 清理@机器人的文本
   - 支持私聊、群聊、超级群聊

3. **并发控制流程**
   - 消息到达 → 检查并发限制 → 开始分析 → 执行任务 → 完成分析
   - 异常情况下自动释放并发槽位

### 类型定义

```typescript
interface ConcurrencyManager {
  globalCount: number;
  groupAnalysis: Map<number, boolean>;
  canStartAnalysis(chatId: number): boolean;
  startAnalysis(chatId: number): void;
  finishAnalysis(chatId: number): void;
  getStatus(): {
    globalCount: number;
    maxConcurrent: number;
    activeGroups: number[];
  };
}
```

## 注意事项

### 群聊权限
- 确保机器人有发送消息的权限
- 建议给机器人管理员权限以便更好地工作

### 性能考虑
- 并发控制基于内存状态，重启后会重置
- 建议根据服务器性能调整 `MAX_CONCURRENT_ANALYSIS`
- 大量群聊时注意监控资源使用情况

### 故障恢复
- 如果分析过程中出现异常，并发槽位会自动释放
- 系统重启后所有并发状态重置
- 建议配置适当的日志级别进行监控

## 升级说明

### 从旧版本升级
1. 更新代码到最新版本
2. 在 `.env` 文件中添加 `MAX_CONCURRENT_ANALYSIS` 配置
3. 重新构建和启动服务
4. 将机器人添加到需要的群聊中

### 兼容性
- 完全向后兼容私聊功能
- 现有的环境变量配置保持不变
- 新增的配置项有合理的默认值

---

**更新时间**: 2025-01-13  
**版本**: v1.1.0
