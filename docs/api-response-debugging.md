# APIå“åº”è°ƒè¯•åŠŸèƒ½æ–‡æ¡£

## ğŸ” é—®é¢˜èƒŒæ™¯

åœ¨ä½¿ç”¨AIæœåŠ¡æ—¶ï¼Œç»å¸¸é‡åˆ°ä»¥ä¸‹JSONè§£æé”™è¯¯ï¼š
```
AI å“åº”è§£æå¤±è´¥ | {"error":"Unexpected token * in JSON at position 0"}
```

è¿™ç±»é”™è¯¯é€šå¸¸æ˜¯å› ä¸ºï¼š
1. **APIè¿”å›æ ¼å¼é”™è¯¯**ï¼šæœåŠ¡è¿”å›çš„ä¸æ˜¯æ ‡å‡†JSONæ ¼å¼
2. **ç½‘ç»œä¼ è¾“é—®é¢˜**ï¼šå“åº”è¢«æˆªæ–­æˆ–æŸå
3. **APIæœåŠ¡å¼‚å¸¸**ï¼šæœåŠ¡è¿”å›é”™è¯¯é¡µé¢è€ŒéJSONæ•°æ®
4. **ç¼–ç é—®é¢˜**ï¼šå“åº”åŒ…å«ç‰¹æ®Šå­—ç¬¦å¯¼è‡´è§£æå¤±è´¥

## ğŸ› ï¸ è§£å†³æ–¹æ¡ˆ

### 1. è¯¦ç»†å“åº”æ—¥å¿—è®°å½•

ä¸ºæ‰€æœ‰AI APIè°ƒç”¨æ·»åŠ äº†è¯¦ç»†çš„å“åº”æ—¥å¿—ï¼š

```typescript
// è·å–å“åº”æ–‡æœ¬
const responseText = await response.text();

// è®°å½•åŸå§‹å“åº”å†…å®¹ä»¥ä¾¿è°ƒè¯•
logger.debug('APIåŸå§‹å“åº”', {
  url: apiUrl,
  responseLength: responseText.length,
  responsePreview: responseText.substring(0, 500) + '...',
  responseText: responseText // å®Œæ•´å“åº”å†…å®¹
});
```

### 2. JSONè§£æé”™è¯¯å¤„ç†

æ”¹è¿›JSONè§£æé€»è¾‘ï¼Œæä¾›è¯¦ç»†é”™è¯¯ä¿¡æ¯ï¼š

```typescript
let data;
try {
  data = JSON.parse(responseText);
} catch (parseError) {
  logger.error('APIå“åº”è§£æå¤±è´¥', {
    error: parseError.message,
    responseText: responseText,
    responseLength: responseText.length,
    contentType: response.headers.get('content-type')
  });
  throw new Error(`AIå“åº”è§£æå¤±è´¥: ${parseError.message}`);
}
```

### 3. æµå¼å“åº”é”™è¯¯å¤„ç†

ä¸ºæµå¼APIæ·»åŠ è§£æé”™è¯¯è®°å½•ï¼š

```typescript
try {
  const parsed = JSON.parse(data);
  // å¤„ç†è§£æåçš„æ•°æ®
} catch (e) {
  logger.debug('æµå¼å“åº”è§£æé”™è¯¯', {
    error: e.message,
    lineData: data,
    lineLength: data.length
  });
}
```

## ğŸ“Š è°ƒè¯•ä¿¡æ¯å±‚çº§

### DEBUGçº§åˆ«æ—¥å¿—
- **APIåŸå§‹å“åº”**ï¼šå®Œæ•´çš„å“åº”å†…å®¹
- **å“åº”é¢„è§ˆ**ï¼šå‰500å­—ç¬¦çš„é¢„è§ˆ
- **æµå¼è§£æé”™è¯¯**ï¼šå•è¡Œæ•°æ®è§£æå¤±è´¥

### ERRORçº§åˆ«æ—¥å¿—
- **APIè¯·æ±‚å¤±è´¥**ï¼šHTTPé”™è¯¯çŠ¶æ€ç 
- **å“åº”è§£æå¤±è´¥**ï¼šJSONè§£æé”™è¯¯è¯¦æƒ…
- **ç©ºå€™é€‰ç»“æœ**ï¼šAPIè¿”å›ç»“æ„å¼‚å¸¸

## ğŸ”§ ä½¿ç”¨æ–¹æ³•

### 1. å¯ç”¨DEBUGæ—¥å¿—

ä¿®æ”¹ç¯å¢ƒå˜é‡æˆ–é…ç½®æ–‡ä»¶ï¼š
```bash
LOG_LEVEL=debug
```

### 2. æŸ¥çœ‹è¯¦ç»†å“åº”

å½“å‡ºç°JSONè§£æé”™è¯¯æ—¶ï¼ŒæŸ¥çœ‹æ—¥å¿—æ–‡ä»¶ï¼š
```bash
tail -f logs/debug.log | grep "APIåŸå§‹å“åº”"
```

### 3. åˆ†æé”™è¯¯åŸå› 

æ ¹æ®æ—¥å¿—ä¿¡æ¯åˆ¤æ–­é”™è¯¯ç±»å‹ï¼š

**æƒ…å†µ1ï¼šHTMLé”™è¯¯é¡µé¢**
```json
{
  "responseText": "<!DOCTYPE html><html><head><title>Error</title>...",
  "contentType": "text/html"
}
```
â†’ APIæœåŠ¡è¿”å›é”™è¯¯é¡µé¢ï¼Œæ£€æŸ¥URLå’Œè®¤è¯

**æƒ…å†µ2ï¼šéƒ¨åˆ†å“åº”**
```json
{
  "responseText": "{\"candidates\":[{\"content\":{\"parts\":[{\"text\":\"åˆ†æå¼€å§‹*",
  "responseLength": 45
}
```
â†’ å“åº”è¢«æˆªæ–­ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜

**æƒ…å†µ3ï¼šéJSONæ ¼å¼**
```json
{
  "responseText": "*å¼€å§‹åˆ†æBTC/USDTçš„æŠ€æœ¯èµ°åŠ¿...",
  "contentType": "text/plain"
}
```
â†’ APIè¿”å›çº¯æ–‡æœ¬ï¼Œæ£€æŸ¥APIé…ç½®

## ğŸš¨ å¸¸è§é”™è¯¯æ¨¡å¼

### Gemini APIé”™è¯¯
- **403 Forbidden**ï¼šAPIå¯†é’¥æ— æ•ˆæˆ–é…é¢ä¸è¶³
- **400 Bad Request**ï¼šè¯·æ±‚æ ¼å¼é”™è¯¯
- **HTMLå“åº”**ï¼šAPIç«¯ç‚¹é”™è¯¯

### OpenAI APIé”™è¯¯
- **401 Unauthorized**ï¼šAPIå¯†é’¥æ— æ•ˆ
- **429 Too Many Requests**ï¼šé¢‘ç‡é™åˆ¶
- **502 Bad Gateway**ï¼šæœåŠ¡æš‚æ—¶ä¸å¯ç”¨

## ğŸ“ˆ ç›‘æ§å»ºè®®

### 1. é”™è¯¯é¢‘ç‡ç›‘æ§
```bash
# ç»Ÿè®¡JSONè§£æé”™è¯¯é¢‘ç‡
grep "å“åº”è§£æå¤±è´¥" logs/error.log | wc -l
```

### 2. å“åº”å†…å®¹åˆ†æ
```bash
# æŸ¥çœ‹æœ€è¿‘çš„å“åº”å†…å®¹
grep -A 5 "APIåŸå§‹å“åº”" logs/debug.log | tail -20
```

### 3. é”™è¯¯æ¨¡å¼è¯†åˆ«
```bash
# æŸ¥æ‰¾HTMLå“åº”é”™è¯¯
grep "<!DOCTYPE html" logs/debug.log
```

## âœ… ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
- åªæœ‰ç®€å•çš„"JSONè§£æå¤±è´¥"é”™è¯¯
- æ— æ³•çŸ¥é“å®é™…çš„å“åº”å†…å®¹
- éš¾ä»¥å®šä½é—®é¢˜æ ¹å› 

### ä¿®å¤å
- **å®Œæ•´å“åº”è®°å½•**ï¼šå¯ä»¥çœ‹åˆ°APIè¿”å›çš„ç¡®åˆ‡å†…å®¹
- **è¯¦ç»†é”™è¯¯ä¿¡æ¯**ï¼šåŒ…å«è§£æé”™è¯¯ä½ç½®å’ŒåŸå› 
- **åˆ†å±‚é”™è¯¯å¤„ç†**ï¼šåŒºåˆ†ä¸åŒç±»å‹çš„é”™è¯¯
- **è°ƒè¯•å‹å¥½**ï¼šä¾¿äºå¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜

é€šè¿‡è¿™äº›æ”¹è¿›ï¼Œç°åœ¨å¯ä»¥å¿«é€Ÿè¯†åˆ«å’Œè§£å†³å„ç§APIå“åº”é—®é¢˜ï¼Œæ˜¾è‘—æå‡ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯ç»´æŠ¤æ€§ã€‚ 